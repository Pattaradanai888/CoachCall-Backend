{
  "__inputs": [],
  "__requires": [
    {"type": "grafana", "id": "grafana", "name": "Grafana", "version": "10"},
    {"type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "2.0.0"},
    {"type": "datasource", "id": "loki", "name": "Loki", "version": "2.0.0"}
  ],
  "title": "FastAPI Observability",
  "uid": "fastapi-observability",
  "version": 3,
  "schemaVersion": 38,
  "tags": ["fastapi", "observability"],
  "timezone": "browser",
  "refresh": "10s",
  "time": {"from": "now-6h", "to": "now"},
  "panels": [
    {
      "type": "stat",
      "title": "Overall RPS",
      "gridPos": {"h": 6, "w": 6, "x": 0, "y": 0},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}},
      "targets": [
        {"expr": "sum(rate(http_requests_total[1m]))", "legendFormat": "rps", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "stat",
      "title": "In-Flight Requests (Concurrency)",
      "gridPos": {"h": 6, "w": 6, "x": 6, "y": 0},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}},
      "targets": [
        {"expr": "inprogress_requests", "legendFormat": "concurrency", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "gauge",
      "title": "Error rate (%)",
      "gridPos": {"h": 6, "w": 6, "x": 12, "y": 0},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "min": 0, "max": 100, "thresholds": {"mode": "percentage", "steps": [{"color": "green"}, {"color": "orange", "value": 1}, {"color": "red", "value": 5}]}},
      "targets": [
        {"expr": "100 * (sum(rate(http_requests_total{status=\"5xx\"}[5m])) / sum(rate(http_requests_total[5m])))", "legendFormat": "error%", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "stat",
      "title": "Availability (30d %)",
      "gridPos": {"h": 6, "w": 6, "x": 18, "y": 0},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "orientation": "horizontal"},
      "fieldConfig": {"defaults": {"unit": "percent"}},
      "targets": [
        {"expr": "100 * avg_over_time(up{job=\"fastapi-app\"}[30d])", "legendFormat": "availability", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "timeseries",
      "title": "Latency p50/p90/p95/p99 (s) - Overall",
      "gridPos": {"h": 10, "w": 24, "x": 0, "y": 6},
      "fieldConfig": {"defaults": {"unit": "s", "min": 0}},
      "options": {"legend": {"displayMode": "table", "placement": "right"}},
      "targets": [
        {"expr": "histogram_quantile(0.50, sum by (le) (rate(http_request_duration_highr_seconds_bucket[5m])))", "legendFormat": "p50", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "histogram_quantile(0.90, sum by (le) (rate(http_request_duration_highr_seconds_bucket[5m])))", "legendFormat": "p90", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "histogram_quantile(0.95, sum by (le) (rate(http_request_duration_highr_seconds_bucket[5m])))", "legendFormat": "p95", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "histogram_quantile(0.99, sum by (le) (rate(http_request_duration_highr_seconds_bucket[5m])))", "legendFormat": "p99", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "sum(rate(http_request_duration_highr_seconds_sum[5m])) / sum(rate(http_request_duration_highr_seconds_count[5m]))", "legendFormat": "average", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "timeseries",
      "title": "Requests by status (rps)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
      "targets": [
        {"expr": "sum by (status) (rate(http_requests_total[5m]))", "legendFormat": "{{status}}", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "timeseries",
      "title": "Requests by method (rps)",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
      "targets": [
        {"expr": "sum by (method) (rate(http_requests_total[5m]))", "legendFormat": "{{method}}", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "timeseries",
      "title": "Requests by handler (rps)",
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 24},
      "options": {"legend": {"displayMode": "list", "placement": "right"}},
      "targets": [
        {"expr": "sum by (handler) (rate(http_requests_total[5m]))", "legendFormat": "{{handler}}", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "timeseries",
      "title": "Main Dashboard RPS (All Endpoints)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
      "targets": [
        {"expr": "rate(http_requests_total{handler=\"/course\"}[5m])", "legendFormat": "/course", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "rate(http_requests_total{handler=\"/course/events/all\"}[5m])", "legendFormat": "/course/events/all", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "rate(http_requests_total{handler=\"/\"}[5m])", "legendFormat": "/ (root)", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "timeseries",
      "title": "Analytics & Auth RPS",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
      "targets": [
        {"expr": "rate(http_requests_total{handler=\"/analytics/coach-stats/all\"}[5m])", "legendFormat": "/analytics/coach-stats/all", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "rate(http_requests_total{handler=\"/auth/me\"}[5m])", "legendFormat": "/auth/me", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "rate(http_requests_total{handler=\"/health-check\"}[5m])", "legendFormat": "/health-check", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "timeseries",
      "title": "Main Dashboard Latency (Available Endpoints)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 40},
      "fieldConfig": {"defaults": {"unit": "s"}},
      "targets": [
        {"expr": "rate(http_request_duration_seconds_sum{handler=\"/course\"}[5m]) / rate(http_request_duration_seconds_count{handler=\"/course\"}[5m])", "legendFormat": "avg /course (if auth working)", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "rate(http_request_duration_seconds_sum{handler=\"/\"}[5m]) / rate(http_request_duration_seconds_count{handler=\"/\"}[5m])", "legendFormat": "avg / (root)", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "timeseries",
      "title": "Coach & Auth Latency (Available Endpoints)",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 40},
      "fieldConfig": {"defaults": {"unit": "s"}},
      "targets": [
        {"expr": "rate(http_request_duration_seconds_sum{handler=\"/metrics\"}[5m]) / rate(http_request_duration_seconds_count{handler=\"/metrics\"}[5m])", "legendFormat": "avg /metrics", "datasource": {"type": "prometheus", "uid": "Prometheus"}},
        {"expr": "rate(http_request_duration_seconds_sum{handler=\"/health-check\"}[5m]) / rate(http_request_duration_seconds_count{handler=\"/health-check\"}[5m])", "legendFormat": "avg /health-check", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "stat",
      "title": "Authentication Status (Requests)",
      "gridPos": {"h": 6, "w": 12, "x": 0, "y": 48},
      "fieldConfig": {"defaults": {"unit": "reqps"}},
      "targets": [
        {"expr": "sum(rate(http_requests_total{handler=~\"/auth.*|/course.*|/analytics.*\", status=\"4xx\"}[5m]))", "legendFormat": "Auth Required", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "stat",
      "title": "Max Concurrency (1h)",
      "gridPos": {"h": 6, "w": 12, "x": 12, "y": 48},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}},
      "targets": [
        {"expr": "max_over_time(inprogress_requests[1h])", "legendFormat": "max conc", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "timeseries",
      "title": "CPU seconds (rate)",
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 54},
      "fieldConfig": {"defaults": {"unit": "ops"}},
      "targets": [
        {"expr": "rate(process_cpu_seconds_total[5m])", "legendFormat": "cpu", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "timeseries",
      "title": "Memory RSS",
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 54},
      "fieldConfig": {"defaults": {"unit": "bytes"}},
      "targets": [
        {"expr": "process_resident_memory_bytes", "legendFormat": "rss", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "stat",
      "title": "Uptime (h)",
      "gridPos": {"h": 6, "w": 8, "x": 0, "y": 62},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}},
      "targets": [
        {"expr": "(time() - process_start_time_seconds) / 3600", "legendFormat": "uptime_h", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },
    {
      "type": "timeseries",
      "title": "GC collections (per gen)",
      "gridPos": {"h": 6, "w": 16, "x": 8, "y": 62},
      "targets": [
        {"expr": "rate(python_gc_collections_total[5m])", "legendFormat": "gen={{generation}}", "datasource": {"type": "prometheus", "uid": "Prometheus"}}
      ]
    },

    {
      "type": "logs",
      "title": "Application Logs (Loki)",
      "gridPos": {"h": 12, "w": 24, "x": 0, "y": 68},
      "options": {"showLabels": true, "wrapLogMessage": true},
      "datasource": {"type": "loki", "uid": "Loki"},
      "targets": [
        {"expr": "{service=~\"fastapi-app|app\"}", "refId": "A"}
      ]
    }
  ]
}
